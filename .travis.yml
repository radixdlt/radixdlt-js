language: node_js
node_js: node
dist: trusty

services:
  - docker

addons:
  sonarcloud:
    organization: "radixdlt-github"
    token:
      secure: "dZ5OHSeX3uOfWFtm0vkfJplYIMOaPTLFtR6OepjTg8UpVoamjgHmmR+EXtN+Oi282T/Bp4peb6OsoACMrMjUSAbrNL2ohewjNEY3VM9DdZt4Pau+ZOiZxC5FqHYjnyvWNuOEtiFARxsh8rcp5weV5hm9/lsTTsHxFPem5gV6aU244qZrMT6xo0jP2r3ms//45xXin7M8TFoh7PFGG3T262rskGDZPiit4aRVZV7REd+90E0TAssnLh1hXz01Qoc1U50B1Yaf6fzyIY4hsN4XJm3p0qEv6y/gtEYw/N6cbonDEBas+aJ/mxuBhoWO9c96OznxoWs+SRM80J4WpnY+Vl22xj5kmD1kIo7ePL3PMd++m7TDWPnqM47yuxCv1hcy1g0hIN2vjE2RYcnxSkSzWu7mjYfWdXW06wCtmQaXX3UjfXG0XE4W/9l4f8GPY3W4Updru8TXwLrmxiYymYAQHM2xbNwa4aTinKCxqmByeNqMjUAeAKmia11DAkje1CMiXDrxu+EA0zwhd4WyAqZfLQ4R3iD1C/qsX3Fc+vBzN3DbpxDdxjrd1TPBN1qalr2ABIIAJanIku8g8sHtf8l0iZfYj6pP7z3PsV3+WL0CiaVmUuH2hUTGvbDiTzlMg4ChlE5BdGPbB3mF/oYQMfr95dOIK5vm45JN1k7G1SnO/3I="

before_install:
  - sudo apt-get -y install build-essential git
  - sudo apt-get -y install gcc-4.8 g++-4.8 && export CXX=g++-4.8
  - sudo apt-get -y install libusb-1.0-0 libusb-1.0-0-dev
  - sudo apt-get -y install libudev-dev
  # Run
  - docker build -t radixdlt-js .
  #  SetUp infrastructure for integration tests
  - docker-compose -f .travisci/minimal-network.yml pull
  - ( docker-compose -f .travisci/minimal-network.yml up & )
  - docker stop radixdlt-js || true && docker rm radixdlt-js || true
  - ( while ! wget -q -O - "http://localhost:8080/api/universe" >/dev/null 2>&1; do echo "Waiting for node to become ready..."; sleep 5; done )

script:
  #  Run unit and integration tests
  - docker run --network host --name radixdlt-js radixdlt-js yarn test:unit && yarn test:integration

after_success:
  # Static analyzers
  - yarn coverage
  - sonar-scanner

env:
  - RADIXDLT_UNIVERSE=v2djcmVhdG9yWCIBApv3kviax5wHBLCRRm5MPwvsdvWxHwZfmQUKyTM8P4OZa2Rlc2NyaXB0aW9ueB5UaGUgUmFkaXggZGV2ZWxvcG1lbnQgVW5pdmVyc2VnZ2VuZXNpc4G/bnBhcnRpY2xlR3JvdXBzgr9pcGFydGljbGVzgb9ocGFydGljbGW/ZWJ5dGVzVwFSYWRpeC4uLiBqdXN0IGltYWdpbmUhbGRlc3RpbmF0aW9uc4FRAt/XxIZXCnrUDrlIyAy4k3ZkZnJvbVgnBAICm/eS+JrHnAcEsJFGbkw/C+x29bEfBl+ZBQrJMzw/g5lhZXUoZW5vbmNlGwAAo9aY1gdyanNlcmlhbGl6ZXJ3cmFkaXgucGFydGljbGVzLm1lc3NhZ2VidG9YJwQCApv3kviax5wHBLCRRm5MPwvsdvWxHwZfmQUKyTM8P4OZYWV1KGd2ZXJzaW9uGGT/anNlcmlhbGl6ZXJzcmFkaXguc3B1bl9wYXJ0aWNsZWRzcGluAWd2ZXJzaW9uGGT/anNlcmlhbGl6ZXJ0cmFkaXgucGFydGljbGVfZ3JvdXBndmVyc2lvbhhk/79pcGFydGljbGVzhL9ocGFydGljbGW/bGRlc3RpbmF0aW9uc4FRAt/XxIZXCnrUDrlIyAy4k3Zlbm9uY2UAY3JyaVg5Bi9KRkxLZVNRbUJaNzNZa3pXaWVzZEVyMmZSVDE0cUNCMURRVXZqOEt4WVFDNm04VVRDY0YvWFJEanNlcmlhbGl6ZXJzcmFkaXgucGFydGljbGVzLnJyaWd2ZXJzaW9uGGT/anNlcmlhbGl6ZXJzcmFkaXguc3B1bl9wYXJ0aWNsZWRzcGluIGd2ZXJzaW9uGGT/v2hwYXJ0aWNsZb9rZGVzY3JpcHRpb25zUmFkaXggTmF0aXZlIFRva2Vuc2xkZXN0aW5hdGlvbnOBUQLf18SGVwp61A65SMgMuJN2a2dyYW51bGFyaXR5WCEFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFnaWNvblVybHg0aHR0cHM6Ly9hc3NldHMucmFkaXhkbHQuY29tL2ljb25zL2ljb24teHJkLTMyeDMyLnBuZ2RuYW1lZFJhZHNrcGVybWlzc2lvbnO/ZGJ1cm5jYWxsZG1pbnRwdG9rZW5fb3duZXJfb25sef9jcnJpWDkGL0pGTEtlU1FtQlo3M1lreldpZXNkRXIyZlJUMTRxQ0IxRFFVdmo4S3hZUUM2bThVVENjRi9YUkRqc2VyaWFsaXplcngvcmFkaXgucGFydGljbGVzLm11dGFibGVfc3VwcGx5X3Rva2VuX2RlZmluaXRpb25jdXJseBlodHRwczovL3d3dy5yYWRpeGRsdC5jb20vZ3ZlcnNpb24YZP9qc2VyaWFsaXplcnNyYWRpeC5zcHVuX3BhcnRpY2xlZHNwaW4BZ3ZlcnNpb24YZP+/aHBhcnRpY2xlv2dhZGRyZXNzWCcEAgKb95L4msecBwSwkUZuTD8L7Hb1sR8GX5kFCskzPD+DmWFldShmYW1vdW50WCEFAAAAAAAAAAAAAAAAAAAAAAAAAAADOy48n9CAPOgAAABsZGVzdGluYXRpb25zgVEC39fEhlcKetQOuUjIDLiTdmtncmFudWxhcml0eVghBQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABZW5vbmNlGwAAo9aY0Grea3Blcm1pc3Npb25zv2RidXJuY2FsbGRtaW50cHRva2VuX293bmVyX29ubHn/anNlcmlhbGl6ZXJ4JHJhZGl4LnBhcnRpY2xlcy50cmFuc2ZlcnJhYmxlX3Rva2Vuc3gYdG9rZW5EZWZpbml0aW9uUmVmZXJlbmNlWDkGL0pGTEtlU1FtQlo3M1lreldpZXNkRXIyZlJUMTRxQ0IxRFFVdmo4S3hZUUM2bThVVENjRi9YUkRndmVyc2lvbhhk/2pzZXJpYWxpemVyc3JhZGl4LnNwdW5fcGFydGljbGVkc3BpbgFndmVyc2lvbhhk/79ocGFydGljbGW/ZmFtb3VudFghBf///////////////////////////MTRw2Avf8MX////bGRlc3RpbmF0aW9uc4FRAt/XxIZXCnrUDrlIyAy4k3ZrZ3JhbnVsYXJpdHlYIQUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWVub25jZRsAAKPWmNDM1mtwZXJtaXNzaW9uc79kYnVybmNhbGxkbWludHB0b2tlbl9vd25lcl9vbmx5/2pzZXJpYWxpemVyeCJyYWRpeC5wYXJ0aWNsZXMudW5hbGxvY2F0ZWRfdG9rZW5zeBh0b2tlbkRlZmluaXRpb25SZWZlcmVuY2VYOQYvSkZMS2VTUW1CWjczWWt6V2llc2RFcjJmUlQxNHFDQjFEUVV2ajhLeFlRQzZtOFVUQ2NGL1hSRGd2ZXJzaW9uGGT/anNlcmlhbGl6ZXJzcmFkaXguc3B1bl9wYXJ0aWNsZWRzcGluAWd2ZXJzaW9uGGT/anNlcmlhbGl6ZXJ0cmFkaXgucGFydGljbGVfZ3JvdXBndmVyc2lvbhhk/2pzZXJpYWxpemVyanJhZGl4LmF0b21qc2lnbmF0dXJlc794IGRmZDdjNDg2NTcwYTdhZDQwZWI5NDhjODBjYjg5Mzc2v2FyWCEBhIkyr5gO8jD5W0g4wcu3SW/QoQLq62Cat0HiWXEooDNhc1ghAQxDE0A+5VPpZkDnnyjL7VnIG8Fy3hsd49fEFxvN4VpVanNlcmlhbGl6ZXJ2Y3J5cHRvLmVjZHNhX3NpZ25hdHVyZWd2ZXJzaW9uGGT//2d2ZXJzaW9uGGT/ZW1hZ2ljOkqX//1kbmFtZWxSYWRpeCBEZXZuZXRkcG9ydBl1MGpzZXJpYWxpemVybnJhZGl4LnVuaXZlcnNla3NpZ25hdHVyZS5yWCEBAd0NS0iSg9feodM7KAZsKoOZjNnvBU5QJ8U2bjqX/yprc2lnbmF0dXJlLnNYIQErJKU5CBYRyszQ62Ix5R9MYjEi+guq5kRB+f7YebvQQWl0aW1lc3RhbXAbAAWbCMH6QABkdHlwZQJndmVyc2lvbhhk/w==